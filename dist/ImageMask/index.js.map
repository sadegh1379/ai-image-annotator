{"version":3,"file":"index.js","names":["_objectSpread","_slicedToArray","React","useState","useEffect","useMemo","useRef","colorInts","useDebounce","loadImage","autoseg","convertToUDTRegions","regions","map","r","type","regionType","classification","cls","x","y","points","_ref","_ref2","centerX","w","centerY","h","width","height","filter","Boolean","ImageMask","_ref3","regionClsList","imageSrc","imagePosition","_ref3$zIndex","zIndex","_ref3$hide","hide","_ref3$autoSegmentatio","autoSegmentationOptions","_useState","_useState2","canvasRef","setCanvasRef","_useState3","_useState4","sampleImageData","setSampleImageData","then","imageData","setConfig","classNames","cp","length","udtRegions","getMask","maskImageData","context","getContext","clearRect","putImageData","style","bottomRight","topLeft","display","undefined","imageRendering","transform","left","top","isNaN","position","pointerEvents","createElement","ref"],"sources":["../../src/ImageMask/index.js"],"sourcesContent":["import _objectSpread from '@babel/runtime/helpers/esm/objectSpread'\nimport _slicedToArray from '@babel/runtime/helpers/esm/slicedToArray'\nimport React, { useState, useEffect, useMemo, useRef } from 'react'\nimport { colorInts } from '../colors'\nimport { useDebounce } from 'react-use'\nimport loadImage from './load-image'\nimport autoseg from 'autoseg/webworker'\n\nfunction convertToUDTRegions(regions) {\n\treturn regions.map(function (r) {\n\t\tswitch (r.type) {\n\t\tcase 'point':\n\t\t\t{\n\t\t\t\treturn {\n\t\t\t\t\tregionType: 'point',\n\t\t\t\t\tclassification: r.cls,\n\t\t\t\t\tx: r.x,\n\t\t\t\t\ty: r.y\n\t\t\t\t}\n\t\t\t}\n\n\t\tcase 'polygon':\n\t\t\t{\n\t\t\t\treturn {\n\t\t\t\t\tregionType: 'polygon',\n\t\t\t\t\tclassification: r.cls,\n\t\t\t\t\tpoints: r.points.map(function (_ref) {\n\t\t\t\t\t\tvar _ref2 = _slicedToArray(_ref, 2),\n\t\t\t\t\t\t\tx = _ref2[0],\n\t\t\t\t\t\t\ty = _ref2[1]\n\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\tx: x,\n\t\t\t\t\t\t\ty: y\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t}\n\n\t\tcase 'box':\n\t\t\t{\n\t\t\t\treturn {\n\t\t\t\t\tregionType: 'bounding-box',\n\t\t\t\t\tclassification: r.cls,\n\t\t\t\t\tcenterX: r.x + r.w / 2,\n\t\t\t\t\tcenterY: r.y + r.h / 2,\n\t\t\t\t\twidth: r.w,\n\t\t\t\t\theight: r.h\n\t\t\t\t}\n\t\t\t}\n\n\t\tdefault:\n\t\t\t{\n\t\t\t\treturn null\n\t\t\t}\n\t\t}\n\t}).filter(Boolean)\n}\n\nexport var ImageMask = function ImageMask(_ref3) {\n\tvar regions = _ref3.regions,\n\t\tregionClsList = _ref3.regionClsList,\n\t\timageSrc = _ref3.imageSrc,\n\t\timagePosition = _ref3.imagePosition,\n\t\t_ref3$zIndex = _ref3.zIndex,\n\t\tzIndex = _ref3$zIndex === void 0 ? 1 : _ref3$zIndex,\n\t\t_ref3$hide = _ref3.hide,\n\t\thide = _ref3$hide === void 0 ? false : _ref3$hide,\n\t\t_ref3$autoSegmentatio = _ref3.autoSegmentationOptions,\n\t\tautoSegmentationOptions = _ref3$autoSegmentatio === void 0 ? {\n\t\t\ttype: 'simple'\n\t\t} : _ref3$autoSegmentatio\n\n  // if (!window.mmgc) window.mmgc = MMGC_INIT()\n  // const mmgc = window.mmgc\n\tvar _useState = useState(null),\n\t\t_useState2 = _slicedToArray(_useState, 2),\n\t\tcanvasRef = _useState2[0],\n\t\tsetCanvasRef = _useState2[1]\n\n\tvar _useState3 = useState(),\n\t\t_useState4 = _slicedToArray(_useState3, 2),\n\t\tsampleImageData = _useState4[0],\n\t\tsetSampleImageData = _useState4[1]\n\n\tuseEffect(function () {\n\t\tif (!imageSrc) return\n\t\tloadImage(imageSrc).then(function (imageData) {\n\t\t\tautoseg.setConfig(_objectSpread({\n\t\t\t\tclassNames: regionClsList\n\t\t\t}, autoSegmentationOptions))\n\t\t\tautoseg.loadImage(imageData)\n\t\t\tsetSampleImageData(imageData)\n\t\t})\n\t}, [imageSrc])\n\tuseDebounce(function () {\n\t\tif (hide) return\n\t\tif (!canvasRef) return\n\t\tif (!sampleImageData) return\n\t\tif (regions.filter(function (cp) {\n\t\t\treturn cp.cls\n\t\t}).length < 2) return\n\t\tvar udtRegions = convertToUDTRegions(regions)\n\t\tautoseg.getMask(udtRegions).then(function (maskImageData) {\n\t\t\tvar context = canvasRef.getContext('2d')\n\t\t\tcontext.clearRect(0, 0, maskImageData.width, maskImageData.height)\n\t\t\tcontext.putImageData(maskImageData, 0, 0)\n\t\t})\n\t}, 1000, [canvasRef, sampleImageData, regions, hide])\n\tvar style = useMemo(function () {\n\t\tvar width = imagePosition.bottomRight.x - imagePosition.topLeft.x\n\t\tvar height = imagePosition.bottomRight.y - imagePosition.topLeft.y\n\t\treturn {\n\t\t\tdisplay: hide ? 'none' : undefined,\n\t\t\timageRendering: 'pixelated',\n\t\t\ttransform: 'translateZ(0px)',\n\t\t\tleft: imagePosition.topLeft.x,\n\t\t\ttop: imagePosition.topLeft.y,\n\t\t\twidth: isNaN(width) ? 0 : width,\n\t\t\theight: isNaN(height) ? 0 : height,\n\t\t\tzIndex: zIndex,\n\t\t\tposition: 'absolute',\n\t\t\tpointerEvents: 'none'\n\t\t}\n\t}, [imagePosition.topLeft.x, imagePosition.topLeft.y, imagePosition.bottomRight.x, imagePosition.bottomRight.y, zIndex, hide])\n\treturn React.createElement('canvas', {\n\t\tstyle: style,\n\t\twidth: sampleImageData ? sampleImageData.width : 0,\n\t\theight: sampleImageData ? sampleImageData.height : 0,\n\t\tref: setCanvasRef\n\t})\n}\nexport default ImageMask"],"mappings":"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"}